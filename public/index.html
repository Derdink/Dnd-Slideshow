<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Photo Slideshow</title>
    <link rel="icon" href="/icons/favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="/icons/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="styles.css" />
    <link rel="manifest" href="manifest.json" />
</head>

<body>
    <div id="slideshow-container">
        <div class="image-container">
            <img id="slide1" class="slide active" src="" alt="Slideshow Image" />
            <img id="slide2" class="slide" src="" alt="Slideshow Image" />
        </div>
        <!-- Title overlay container with two overlaid elements -->
        <div class="title-container">
            <div id="title-overlay1" class="title-overlay active"></div>
            <div id="title-overlay2" class="title-overlay"></div>
            <!-- Verify these elements exist and have the correct IDs -->
            <div id="subtitle-overlay1" class="subtitle-overlay active"></div>
            <div id="subtitle-overlay2" class="subtitle-overlay"></div>
        </div>
        <!-- Left hover area -->
        <div class="hover-area left" onclick="prevImage()">
            <div class="nav-button">‹</div>
        </div>
        <!-- Right hover area -->
        <div class="hover-area right" onclick="nextImage()">
            <div class="nav-button">›</div>
        </div>
    </div>

    <!-- Update Socket.IO script to use specific version and load before other scripts -->
    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Verify Socket.IO is loaded
        if (typeof io === 'undefined') {
            console.error('Socket.IO failed to load');
        }
    </script>
    <script src="socket-client.js"></script>
    <script src="main.js"></script>
    <script src="sw-register.js"></script>
    <script>
        // Use window.socket from socket-client.js
        window.socket.on('settingsUpdate', ({
            speed,
            order
        }) => {
            localStorage.setItem('transitionTime', speed);
            localStorage.setItem('slideshowOrder', order);
            location.reload(); // Reload to apply new settings
        });

        window.socket.on('playImage', ({
            imageUrl,
            title,
            description
        }) => {
            let slide1 = document.getElementById('slide1');
            let titleOverlay = document.getElementById('title-overlay1');
            let subtitleOverlay = document.getElementById('subtitle-overlay1');
            let slide2 = document.getElementById('slide2');
            let titleOverlay2 = document.getElementById('title-overlay2');
            let subtitleOverlay2 = document.getElementById('subtitle-overlay2');
            if (slide1 && slide2) {
                slide2.src = imageUrl;
                if (titleOverlay2) {
                    titleOverlay2.innerText = title;
                }
                if (subtitleOverlay2) {
                    subtitleOverlay2.innerText = description || '';
                }
                // Only clear the interval. Do NOT restart the slideshow.
                clearInterval(window.slideshowInterval);
                slide2.onload = () => {
                    slide2.classList.add('active');
                    slide1.classList.remove('active');
                    if (titleOverlay && titleOverlay2) {
                        titleOverlay2.classList.add('active');
                        titleOverlay.classList.remove('active');
                    }
                    if (subtitleOverlay && subtitleOverlay2) {
                        subtitleOverlay2.classList.add('active');
                        subtitleOverlay.classList.remove('active');
                    }
                    setTimeout(() => {
                        let tempImg = slide1;
                        slide1 = slide2;
                        slide2 = tempImg;
                        if (titleOverlay && titleOverlay2) {
                            let tempTitle = titleOverlay;
                            titleOverlay = titleOverlay2;
                            titleOverlay2 = tempTitle;
                        }
                        if (subtitleOverlay && subtitleOverlay2) {
                            let tempSubtitle = subtitleOverlay;
                            subtitleOverlay = subtitleOverlay2;
                            subtitleOverlay2 = tempSubtitle;
                        }
                    }, 1000);
                };
            }
        });

        window.socket.on('playSelect', ({
            images
        }) => {
            console.log('Received playSelect event:', images);

            if (document.getElementById('slide1') && images && images.length > 0) {
                // Stop any existing slideshow
                clearInterval(window.slideshowInterval);

                // Reset slideshow state
                window.slideshowPaused = false;
                window.selectedSlideshowImages = images;
                window.currentIndex = 0;

                // Always use crossfade for transitions
                if (typeof window.crossfadeTo === 'function') {
                    try {
                        window.crossfadeTo(0, images);
                        console.log('Crossfade initiated successfully');
                    } catch (error) {
                        console.error('Error in crossfadeTo:', error);
                    }
                }

                // Only start automatic slideshow if there's more than one image
                if (images.length > 1) {
                    if (typeof window.startSlideshow === 'function') {
                        window.startSlideshow();
                        console.log('Slideshow started');
                    }
                }
            }
        });

        window.socket.on('slideAction', ({
            action
        }) => {
            console.log('Received slideAction:', action);
            console.log('Navigation functions available:', {
                nextImage: typeof window.nextImage === 'function',
                prevImage: typeof window.prevImage === 'function'
            });

            if (action === 'next' && typeof window.nextImage === 'function') {
                console.log('Executing next image transition');
                window.nextImage();
            } else if (action === 'prev' && typeof window.prevImage === 'function') {
                console.log('Executing prev image transition');
                window.prevImage();
            } else {
                console.warn('Cannot execute navigation:', {
                    action,
                    hasNextImage: typeof window.nextImage === 'function',
                    hasPrevImage: typeof window.prevImage === 'function'
                });
            }
        });

        window.socket.on('slideAction', ({
            action
        }) => {
            console.log('Received slideAction:', action);

            if (action === 'pause') {
                window.slideshowPaused = true;
                clearInterval(window.slideshowInterval);
            } else if (action === 'play') {
                window.slideshowPaused = false;
                const transitionTime = parseFloat(localStorage.getItem('transitionTime')) || 3;
                window.slideshowInterval = setInterval(window.nextImage, transitionTime * 1000);
            }
        });
    </script>
</body>

</html>