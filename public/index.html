<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Photo Slideshow</title>
    <link rel="icon" href="/icons/favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="/icons/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="styles.css" />
    <link rel="manifest" href="manifest.json" />
</head>

<body>
    <div id="slideshow-container">
        <div class="image-container">
            <img id="slide1" class="slide active" src="" alt="Slideshow Image" />
            <img id="slide2" class="slide" src="" alt="Slideshow Image" />
        </div>
        <!-- Title overlay container with two overlaid elements -->
        <div class="title-container">
            <div id="title-overlay1" class="title-overlay active"></div>
            <div id="title-overlay2" class="title-overlay"></div>
            <!-- Verify these elements exist and have the correct IDs -->
            <div id="subtitle-overlay1" class="subtitle-overlay active"></div>
            <div id="subtitle-overlay2" class="subtitle-overlay"></div>
        </div>
        <!-- Left hover area -->
        <div class="hover-area left" onclick="prevImage()">
            <div class="nav-button">‹</div>
        </div>
        <!-- Right hover area -->
        <div class="hover-area right" onclick="nextImage()">
            <div class="nav-button">›</div>
        </div>
    </div>

    <!-- Load Socket.IO first -->
    <script src="/socket.io/socket.io.js"></script>
    <!-- Then load main.js which depends on socket.io -->
    <script src="main.js"></script>
    <script src="sw-register.js"></script>

    <!-- Move socket client configuration after Socket.IO is loaded -->
    <script>
        // Verify Socket.IO is loaded
        if (typeof io === 'undefined') {
            console.error('Socket.IO failed to load');
        }
    </script>
    <script src="socket-client.js"></script>
    <script>
        // Use window.socket from socket-client.js
        window.socket.on('settingsUpdate', ({
            speed,
            order
        }) => {
            console.log('Received settings update:', { speed, order });
            
            // Update both localStorage and window context
            localStorage.setItem('transitionTime', speed);
            localStorage.setItem('slideshowOrder', order);
            window.transitionTime = speed;
            window.slideshowOrder = order;
            
            // Reset interval with new speed
            if (window.slideshowInterval) {
                clearInterval(window.slideshowInterval);
                window.slideshowInterval = setInterval(window.nextImage, speed * 1000);
            }
        });

        window.socket.on('playImage', ({
            imageUrl,
            title,
            description
        }) => {
            let slide1 = document.getElementById('slide1');
            let titleOverlay = document.getElementById('title-overlay1');
            let subtitleOverlay = document.getElementById('subtitle-overlay1');
            let slide2 = document.getElementById('slide2');
            let titleOverlay2 = document.getElementById('title-overlay2');
            let subtitleOverlay2 = document.getElementById('subtitle-overlay2');
            if (slide1 && slide2) {
                slide2.src = imageUrl;
                if (titleOverlay2) {
                    titleOverlay2.innerText = title;
                }
                if (subtitleOverlay2) {
                    subtitleOverlay2.innerText = description || '';
                }
                // Only clear the interval. Do NOT restart the slideshow.
                clearInterval(window.slideshowInterval);
                slide2.onload = () => {
                    slide2.classList.add('active');
                    slide1.classList.remove('active');
                    if (titleOverlay && titleOverlay2) {
                        titleOverlay2.classList.add('active');
                        titleOverlay.classList.remove('active');
                    }
                    if (subtitleOverlay && subtitleOverlay2) {
                        subtitleOverlay2.classList.add('active');
                        subtitleOverlay.classList.remove('active');
                    }
                    setTimeout(() => {
                        let tempImg = slide1;
                        slide1 = slide2;
                        slide2 = tempImg;
                        if (titleOverlay && titleOverlay2) {
                            let tempTitle = titleOverlay;
                            titleOverlay = titleOverlay2;
                            titleOverlay2 = tempTitle;
                        }
                        if (subtitleOverlay && subtitleOverlay2) {
                            let tempSubtitle = subtitleOverlay;
                            subtitleOverlay = subtitleOverlay2;
                            subtitleOverlay2 = tempSubtitle;
                        }
                    }, 1000);
                };
            }
        });

        window.socket.on('playSelect', ({
            images,
            speed,
            order
        }) => {
            console.log('Received playSelect event:', {
                imagesCount: images?.length,
                speed,
                order,
                currentOrder: window.slideshowOrder
            });

            if (!images || !Array.isArray(images) || images.length === 0) {
                console.error('Invalid images data received');
                return;
            }

            // Stop any existing slideshow
            if (window.slideshowInterval) {
                clearInterval(window.slideshowInterval);
                window.slideshowInterval = null;
            }

            // Update settings - ensure speed is set in both localStorage and window context
            if (speed) {
                localStorage.setItem('transitionTime', speed);
                window.transitionTime = speed;
            }
            if (order) {
                localStorage.setItem('slideshowOrder', order);
                window.slideshowOrder = order;
            }

            // Reset slideshow state
            window.slideshowPaused = false;
            window.currentIndex = 0;
            window.usedRandomImages = new Set();

            // Store images globally
            window.selectedSlideshowImages = [...images];
            window.images = [...images]; // Ensure fallback is also set

            // Initialize first image
            if (window.selectedSlideshowImages.length > 0) {
                const firstImage = window.selectedSlideshowImages[0];
                const slide1 = document.getElementById('slide1');
                const titleOverlay1 = document.getElementById('title-overlay1');
                const subtitleOverlay1 = document.getElementById('subtitle-overlay1');

                if (slide1) {
                    // Set initial image
                    slide1.src = firstImage.url;
                    if (titleOverlay1) titleOverlay1.innerText = firstImage.title || '';
                    if (subtitleOverlay1) subtitleOverlay1.innerText = firstImage.description || '';
                }
            }

            // Start slideshow if there are multiple images
            if (window.selectedSlideshowImages.length > 1) {
                const currentSpeed = window.transitionTime || parseFloat(localStorage.getItem('transitionTime')) || 3;
                window.slideshowInterval = setInterval(window.nextImage, currentSpeed * 1000);
            }
        });

        window.socket.on('slideAction', ({
            action
        }) => {
            console.log('Received slideAction:', action);
            console.log('Navigation functions available:', {
                nextImage: typeof window.nextImage === 'function',
                prevImage: typeof window.prevImage === 'function'
            });

            if (action === 'next' && typeof window.nextImage === 'function') {
                console.log('Executing next image transition');
                window.nextImage();
            } else if (action === 'prev' && typeof window.prevImage === 'function') {
                console.log('Executing prev image transition');
                window.prevImage();
            } else {
                console.warn('Cannot execute navigation:', {
                    action,
                    hasNextImage: typeof window.nextImage === 'function',
                    hasPrevImage: typeof window.prevImage === 'function'
                });
            }
        });

        window.socket.on('slideAction', ({
            action
        }) => {
            console.log('Received slideAction:', action);

            if (action === 'pause') {
                window.slideshowPaused = true;
                clearInterval(window.slideshowInterval);
            } else if (action === 'play') {
                window.slideshowPaused = false;
                const transitionTime = parseFloat(localStorage.getItem('transitionTime')) || 3;
                window.slideshowInterval = setInterval(window.nextImage, transitionTime * 1000);
            }
        });
    </script>
</body>

</html>